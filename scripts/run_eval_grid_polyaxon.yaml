---
version: 1

kind: group

environment:
  resources:
    gpu:
      requests: 1
      limits: 1

hptuning:

  concurrency: 4

  matrix:
    n_source:
      values: [1, 5]
    n_target:
      values: [8, 16]
    random_seed:
      values: [1, 2, 3]

build:
  image: pytorch/pytorch:1.6.0-cuda10.1-cudnn7-devel
  build_steps:
    - apt-get update
    - apt-get install ffmpeg libsm6 libxext6 libmagickwand-dev -y
    - pip install --no-cache-dir -r requirements.txt
  env_vars:
    - ['LC_ALL', 'C.UTF-8']
    - ['PYTHONPATH', '$PYTHONPATH:/code']


run:
  cmd:
    # Allow to access the mounted data_folder as if it was in ./data
    - ln -s /media/etienneb ./data
    # Allow to access the mounted output_folder as if it was in ./output
    - ln -s $POLYAXON_RUN_OUTPUTS_PATH ./output
    # Create grid
    - 'echo "N_SOURCE = {{ n_source }}" >> ./configs/training_config.py'
    - 'echo "N_TARGET = {{ n_target }}" >> ./configs/training_config.py'
    - 'echo "RANDOM_SEED = {{ random_seed }}" >> ./configs/experiment_config.py'
    # Evaluate without OT
    - python -m scripts.eval_model --model-path=/output/sicara/meta-domain-shift/experiments/260/Conv4_CIFAR100CMeta.tar --episodic=False --use-fc=False --force-ot=False
    # Then evaluate with OT
    - 'echo "SAVE_DIR = SECOND_EVAL_SAVE_DIR" >> ./configs/experiment_config.py'
    - python -m scripts.eval_model --model-path=/output/sicara/meta-domain-shift/experiments/260/Conv4_CIFAR100CMeta.tar --episodic=False --use-fc=False --force-ot=True